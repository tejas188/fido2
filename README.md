# Solo Keys Firmware Build Guide

This guide provides step-by-step instructions to build and flash custom firmware for Solo Keys FIDO2 security keys (STM32L432 target).

## Prerequisites

- Ubuntu/Debian-based Linux system (or WSL2)
- Root/sudo access
- USB connection to Solo Key device
- ST-Link programmer (for SWD flashing) or DFU mode support

## Build Instructions

### 1. Install Dependencies

```bash
sudo apt install -y build-essential git python3 python3-venv python3-pip \
  gcc-arm-none-eabi binutils-arm-none-eabi dfu-util stlink-tools openssl pkg-config
```

### 2. Clone and Setup Repository

```bash
git clone --recurse-submodules https://github.com/solokeys/solo
cd solo
git fetch --tags
git checkout 2.5.3
git submodule update --init --recursive
```

### 3. Setup Python Environment

```bash
python3 -m venv venv
source venv/bin/activate
python -m pip install --upgrade pip setuptools wheel
pip install -r tools/requirements.txt
pip install solo-python
pip install 'fido2==0.9.2'
```

### 4. Build Firmware and Bootloader

```bash
cd targets/stm32l432
make cbor
make build-hacker
```

The `make build-hacker` command will:
- Build the tinycbor library
- Build the salty crypto library
- Compile the bootloader (non-verifying)
- Compile the application firmware (with hacker flags)
- Merge both into `all.hex`

### 5. Generate Custom Attestation Certificate (Optional)

If you want to use a custom attestation certificate instead of the default "hacker" certificate:

```bash
# Generate EC private key (prime256v1/secp256r1)
openssl ecparam -name prime256v1 -genkey -noout -out attestation.key

# Create self-signed certificate
openssl req -new -x509 -key attestation.key -out attestation.pem -days 3650 \
  -subj "/CN=SoloKeys Attestation/"

# Convert to DER format
openssl x509 -in attestation.pem -outform DER -out attestation.der
```

**Important:** You need to extract the private key from `attestation.key` and convert it to hex format for the next step.

### 6. Merge Hex Files with Custom Attestation

```bash
# Replace with your actual hex-encoded private key
solo mergehex \
  --attestation-key "0445a902c12e9c0a33fa3e84504ab802dc4db9af15b1b63aea8d3f03035565657d703fb402a497f483b8a6f93cd018ad920cb78a5a3e144892ef08f8caeafb32ab20" \
  --attestation-cert attestation.der \
  solo.hex \
  bootloader.hex \
  bundle.hex
```

> **Note:** The attestation key must match the private key used to generate `attestation.der`. The key should be the raw private key bytes in hexadecimal format (64 hex characters for P-256).

### 7. Convert to Binary (Optional)

```bash
arm-none-eabi-objcopy -I ihex bundle.hex -O binary bundle.bin
```

## Flashing the Firmware

### Option 1: Using ST-Link (SWD)

```bash
# Unlock and erase flash
STM32_Programmer_CLI -c port=SWD -halt -e all --readunprotect

# Flash the firmware
STM32_Programmer_CLI -c port=SWD -halt -d bundle.hex -rst
```

### Option 2: Using DFU Mode

```bash
# Put device in DFU mode, then:
STM32_Programmer_CLI -c port=usb1 -halt -rdu -d bundle.hex
```

### Option 3: Using Solo CLI Tools

```bash
# Enter bootloader mode
solo program aux enter-bootloader

# Flash the firmware
solo program bootloader solo.hex
```

## Build Variants

### Build Only Application (without bootloader)

```bash
make cbor
make all-hacker    # For hacker/development build
# OR
make firmware      # For production build
```

### Build Only Bootloader

```bash
make bootloader-nonverifying  # Non-verifying bootloader (development)
# OR
make bootloader-verifying     # Signature-verifying bootloader (production)
```

### Debug Builds

```bash
make firmware-debug-1  # Debug level 1
make firmware-debug-2  # Debug level 2
```

## Troubleshooting

### "Flash algorithm write command FAILURE"

```bash
# Unlock the device
STM32_Programmer_CLI -c port=SWD -halt -e all --readunprotect

# Try flashing again with hardware reset
STM32_Programmer_CLI -c port=SWD reset=HWrst -halt -d bundle.hex -rst
```

### Build Errors

```bash
# Clean everything and rebuild
make clean2
make cbor
make build-hacker
```

### Submodule Issues

```bash
git submodule update --init --recursive --force
```

## Important Notes

- **Hacker Build**: The `build-hacker` target creates a development firmware with debugging enabled and no signature verification
- **Attestation Keys**: Always keep your attestation private key secure. The key embedded in the firmware is used to sign FIDO2 attestations
- **ROP (Readout Protection)**: Production builds should use `make build-release-locked` to enable flash readout protection
- **Version**: This guide is for Solo Keys firmware version 2.5.3

## Output Files

- `solo.hex` - Application firmware
- `bootloader.hex` - Bootloader firmware  
- `all.hex` - Merged firmware (auto-generated by `build-hacker`)
- `bundle.hex` - Merged firmware with custom attestation
- `bundle.bin` - Binary format (optional)

## References

- [Solo Keys GitHub Repository](https://github.com/solokeys/solo)
- [Solo Keys Documentation](https://docs.solokeys.io/)
- [FIDO2 Specification](https://fidoalliance.org/specs/fido-v2.0-ps-20190130/fido-client-to-authenticator-protocol-v2.0-ps-20190130.html)

## License

This build guide is for the Solo Keys open-source firmware. Refer to the original repository for licensing information.

---

**⚠️ Warning**: Flashing custom firmware may brick your device. Ensure you have proper recovery tools and knowledge before proceeding. The maintainers are not responsible for any damage to your device.
